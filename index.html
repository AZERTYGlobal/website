<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="assets/favicon-azerty-global.png">
  <title>AZERTY Global ‚Äî Corrigez l'AZERTY, gardez vos habitudes</title>
  <meta name="description"
    content="Majuscules accentu√©es faciles (√â √à √á √Ä), typographie parfaite (¬´ ¬ª ‚Äì ‚Äî), symboles dev accessibles et langues √©trang√®res. Gratuit pour Windows, macOS et Linux.">

  <!-- Canonical URL -->
  <link rel="canonical" href="https://azerty.global/">
  <link rel="alternate" hreflang="fr" href="https://azerty.global/">
  <link rel="alternate" hreflang="x-default" href="https://azerty.global/">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://azerty.global/">
  <meta property="og:title" content="AZERTY Global ‚Äî Corrigez l'AZERTY, gardez vos habitudes">
  <meta property="og:description"
    content="Majuscules accentu√©es faciles (√â √à √á √Ä), typographie parfaite (¬´ ¬ª ‚Äì ‚Äî), symboles dev accessibles et langues √©trang√®res. Gratuit pour Windows, macOS et Linux.">
  <meta property="og:image" content="https://azerty.global/assets/og-image.png">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://azerty.global/">
  <meta name="twitter:title" content="AZERTY Global ‚Äî Corrigez l'AZERTY, gardez vos habitudes">
  <meta name="twitter:description"
    content="Majuscules accentu√©es faciles (√â √à √á √Ä), typographie parfaite (¬´ ¬ª ‚Äì ‚Äî), symboles dev accessibles et langues √©trang√®res. Gratuit pour Windows, macOS et Linux.">
  <meta name="twitter:image" content="https://azerty.global/assets/og-image.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="tester/keyboard.css">

  <!-- Theme (load early to prevent flash) -->
  <script src="js/theme.js"></script>

  <!-- Cloudflare Web Analytics -->
  <script defer src='https://static.cloudflareinsights.com/beacon.min.js'
    data-cf-beacon='{"token": "bc30c343130f4bfa88c667173f84e324"}'></script>

  <!-- Schema.org SoftwareApplication -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "AZERTY Global",
      "alternateName": "AZERTY Global 2026",
      "applicationCategory": "UtilitiesApplication",
      "applicationSubCategory": "Keyboard Layout",
      "operatingSystem": "Windows 10, Windows 11, macOS, Linux",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "EUR"
      },
      "description": "Disposition de clavier fran√ßaise modernis√©e pour Windows, macOS et Linux. Facilite les majuscules accentu√©es, la programmation, la typographie fran√ßaise et les langues √©trang√®res. Alternative √† l'AZERTY AFNOR avec une transition douce.",
      "softwareVersion": "2026",
      "author": {
        "@type": "Person",
        "name": "Antoine Olivier"
      },
      "publisher": {
        "@type": "Organization",
        "name": "AZERTY Global",
        "url": "https://azerty.global",
        "logo": "https://azerty.global/assets/logo-azerty-global.png",
        "sameAs": [
          "https://github.com/AZERTYGlobal",
          "https://discord.gg/nYknqshJz3"
        ]
      },
      "downloadUrl": "https://azerty.global/download.html",
      "softwareHelp": "https://azerty.global/guide.html",
      "releaseNotes": "https://azerty.global/a-propos.html",
      "license": "https://creativecommons.org/licenses/by-sa/4.0/",
      "isAccessibleForFree": true,
      "featureList": [
        "Majuscules accentu√©es : Verr. Maj + √© = √â, Verr. Maj + √® = √à, Verr. Maj + √† = √Ä, Verr. Maj + √ß = √á",
        "Guillemets fran√ßais : AltGr + W = ¬´, AltGr + X = ¬ª",
        "Ligature ≈ì : AltGr + O = ≈ì",
        "Ligature √¶ : AltGr + A = √¶",
        "Tiret cadratin : AltGr + - = ‚Äî",
        "Espace ins√©cable : AltGr + Espace",
        "Arobase @ : touche √† gauche du 1 (acc√®s direct)",
        "Accolades : AltGr + D = {, AltGr + F = }",
        "Crochets : AltGr + J = [, AltGr + K = ]",
        "Barre verticale : AltGr + L = |",
        "Backslash : AltGr + M = \\",
        "Euro : AltGr + E = ‚Ç¨",
        "Langues √©trang√®res : touches mortes pour √±, √ü, √∏, √º, √°, etc.",
        "Compatible jeux vid√©o : touches ZQSD inchang√©es",
        "5 changements seulement par rapport √† l'AZERTY Windows"
      ],
      "keywords": "AZERTY, clavier fran√ßais, disposition clavier, majuscules accentu√©es, √â √à √Ä √á, typographie fran√ßaise, programmation, guillemets fran√ßais, ≈ì, √¶"
    }
    </script>
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "AZERTY Global",
      "url": "https://azerty.global",
      "logo": "https://azerty.global/assets/logo-azerty-global.png",
      "description": "Projet open source proposant une disposition de clavier fran√ßaise am√©lior√©e, alternative √† l'AZERTY AFNOR.",
      "foundingDate": "2017",
      "founder": {
        "@type": "Person",
        "name": "Antoine Olivier"
      },
      "sameAs": [
        "https://github.com/AZERTYGlobal",
        "https://discord.gg/nYknqshJz3"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "email": "contact@azerty.global",
        "contactType": "customer support"
      }
    }
    </script>
  <!-- Schema.org WebSite (for Google site name in search results) -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "AZERTY Global",
      "alternateName": "AZERTY Global 2026",
      "url": "https://azerty.global",
      "description": "Disposition de clavier fran√ßaise modernis√©e. Majuscules accentu√©es faciles, typographie parfaite, symboles dev accessibles.",
      "inLanguage": "fr",
      "publisher": {
        "@type": "Organization",
        "name": "AZERTY Global",
        "logo": {
          "@type": "ImageObject",
          "url": "https://azerty.global/assets/favicon-azerty-global.png"
        }
      }
    }
    </script>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="container header__inner">
      <a href="index.html" class="header__logo">
        <img src="assets/logo-azerty-global.png" alt="Logo AZERTY Global - Clavier ergonomique fran√ßais"
          class="header__logo-img">
      </a>

      <nav class="nav" role="navigation" aria-label="Navigation principale">
        <a href="index.html" class="nav__link nav__link--active">Accueil</a>
        <a href="download.html" class="nav__link">T√©l√©charger</a>
        <a href="guide.html" class="nav__link">Guide</a>
        <a href="comparatif.html" class="nav__link">Comparatif</a>
        <a href="feedback.html" class="nav__link">Feedback</a>
        <div class="nav__dropdown">
          <button class="nav__dropdown-toggle">Plus</button>
          <div class="nav__dropdown-menu">
            <a href="faq.html" class="nav__dropdown-item">FAQ</a>
            <a href="presse.html" class="nav__dropdown-item">Presse</a>
            <a href="licence.html" class="nav__dropdown-item">Licence</a>
            <a href="mentions-legales.html" class="nav__dropdown-item">Mentions L√©gales</a>
            <a href="a-propos.html" class="nav__dropdown-item">√Ä propos</a>
            <div style="height: 1px; background: var(--border-color); margin: var(--space-1) 0;"></div>
            <a href="https://www.paypal.com/paypalme/azertyglobal" target="_blank" class="nav__dropdown-item"
              style="color: var(--color-accent);">Faire un don ‚ù§Ô∏è</a>
          </div>
        </div>
      </nav>

      <div style="display: flex; gap: var(--space-2);">
        <button class="theme-toggle" aria-label="Changer le th√®me">
          <span class="theme-toggle__icon--dark">üåô</span>
          <span class="theme-toggle__icon--light">‚òÄÔ∏è</span>
        </button>
        <button class="nav__toggle" aria-label="Menu" aria-expanded="false">‚ò∞</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Hero Section -->
    <section class="hero">
      <div class="container">
        <h1 class="hero__title">L'AZERTY corrig√©, pas r√©invent√©</h1>
        <p
          style="color: var(--text-secondary); font-size: var(--text-lg); margin-top: var(--space-2); margin-bottom: var(--space-4);">
          Facile √† apprendre, productivit√© imm√©diate.
        </p>

        <p class="hero__subtitle" style="max-width: 100%;">
          Majuscules accentu√©es faciles ‚Ä¢ Typographie parfaite ‚Ä¢ Verr. Maj. intelligent<br>
          Symboles dev accessibles ‚Ä¢ Caract√®res internationaux
        </p>

        <!-- Keyboard Map Preview (hover to see full) -->
        <div class="hero__keyboard">
          <img src="images/carte-simplifiee.svg" alt="Carte simplifi√©e du clavier AZERTY Global"
            class="hero__keyboard-img hero__keyboard-img--simple">
          <img src="images/carte-complete.svg" alt="Carte compl√®te du clavier AZERTY Global"
            class="hero__keyboard-img hero__keyboard-img--full">

          <!-- Arobase Hotspot (E00 key) -->
          <div class="keyboard-hotspot keyboard-hotspot--at" aria-label="Arobase">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">@</span> Arobase</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                Acc√®s direct
              </div>
            </div>
          </div>

          <!-- Hashtag Hotspot (E00 key - Shift) -->
          <div class="keyboard-hotspot keyboard-hotspot--hashtag" aria-label="Hashtag">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">#</span> Hashtag</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Maj</kbd> + <kbd class="keyboard-tooltip__key">@</kbd>
              </div>
            </div>
          </div>

          <!-- Ampersand Hotspot (E01 key) -->
          <div class="keyboard-hotspot keyboard-hotspot--ampersand" aria-label="Esperluette">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">&</span> Esperluette</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                Acc√®s direct
              </div>
            </div>
          </div>

          <!-- E-dans-l'A Hotspot (A key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--ae" aria-label="E-dans-l'A">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">√¶</span> E-dans-l'A</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">A</kbd>
              </div>
            </div>
          </div>

          <!-- Euro Hotspot (E key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--euro" aria-label="Euro">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">‚Ç¨</span> Euro</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">E</kbd>
              </div>
            </div>
          </div>

          <!-- Demi-cadratin (En Dash) Hotspot (T key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--dash-em" aria-label="Tiret demi-cadratin">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">‚Äì</span> Tiret
                demi-cadratin</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">T</kbd>
              </div>
            </div>
          </div>

          <!-- Cadratin (Em Dash) Hotspot (T key - Shift+AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--dash-en" aria-label="Tiret cadratin">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">‚Äî</span> Tiret cadratin</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">Maj</kbd> + <kbd
                  class="keyboard-tooltip__key">T</kbd>
              </div>
            </div>
          </div>

          <!-- U accent grave Hotspot (U key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--u-grave" aria-label="U accent grave">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">√π</span> U accent grave</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">U</kbd>
              </div>
            </div>
          </div>

          <!-- E-dans-l'O Hotspot (O key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--oe" aria-label="E-dans-l'O">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">≈ì</span> E-dans-l'O</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">O</kbd>
              </div>
            </div>
          </div>

          <!-- Livre Sterling Hotspot (D12 key - Shift position) -->
          <div class="keyboard-hotspot keyboard-hotspot--pound" aria-label="Livre sterling">
            <div class="keyboard-tooltip keyboard-tooltip--left">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">¬£</span> Livre sterling</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Maj</kbd> + <kbd class="keyboard-tooltip__key">$</kbd>
              </div>
            </div>
          </div>

          <!-- Opening Curly Brace Hotspot (C03 key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--brace-left" aria-label="Accolade ouvrante">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">{</span> Accolade
                ouvrante</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">D</kbd>
              </div>
            </div>
          </div>

          <!-- Closing Curly Brace Hotspot (C04 key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--brace-right" aria-label="Accolade fermante">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">}</span> Accolade
                fermante</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">F</kbd>
              </div>
            </div>
          </div>

          <!-- Backslash Hotspot (C05 key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--backslash" aria-label="Backslash">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">\</span> Backslash</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">G</kbd>
              </div>
            </div>
          </div>

          <!-- Pipe Hotspot (C06 key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--pipe" aria-label="Barre verticale">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">|</span> Barre verticale</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">H</kbd>
              </div>
            </div>
          </div>

          <!-- Opening Bracket Hotspot (C07 key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--bracket-left" aria-label="Crochet ouvrant">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">[</span> Crochet ouvrant</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">J</kbd>
              </div>
            </div>
          </div>

          <!-- Closing Bracket Hotspot (C08 key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--bracket-right" aria-label="Crochet fermant">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">]</span> Crochet fermant</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">K</kbd>
              </div>
            </div>
          </div>

          <!-- Guillemet Ouvrant Hotspot (W key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--guillemet-left" aria-label="Guillemet ouvrant">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">¬´</span> Guillemet
                ouvrant</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">W</kbd>
              </div>
            </div>
          </div>

          <!-- Guillemet-Apostrophe double culbut√© Hotspot (W key - Shift+AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--double-quote-left"
            aria-label="Guillemet-Apostrophe double culbut√©">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">"</span> Guillemet double
                ouvrant</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">Maj</kbd> + <kbd
                  class="keyboard-tooltip__key">W</kbd>
              </div>
            </div>
          </div>

          <!-- Guillemet Fermant Hotspot (X key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--guillemet-right" aria-label="Guillemet fermant">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">¬ª</span> Guillemet
                fermant</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">X</kbd>
              </div>
            </div>
          </div>

          <!-- Guillemet double fermant Hotspot (X key - Shift+AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--double-quote-right" aria-label="Guillemet double fermant">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">"</span> Guillemet double
                fermant</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">Maj</kbd> + <kbd
                  class="keyboard-tooltip__key">X</kbd>
              </div>
            </div>
          </div>

          <!-- Eszett Hotspot (B key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--eszett" aria-label="Eszett">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">√ü</span> Eszett</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">B</kbd>
              </div>
            </div>
          </div>

          <!-- Backtick (`) Hotspot (N key - Shift+AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--backtick" aria-label="Backtick">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">`</span> Backtick</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">Maj</kbd> + <kbd
                  class="keyboard-tooltip__key">N</kbd>
              </div>
            </div>
          </div>

          <!-- Inverted Question Mark Hotspot (Comma key - Shift+AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--question-inverted" aria-label="Point d'interrogation culbut√©">
            <div class="keyboard-tooltip" style="min-width: 250px;">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">¬ø</span> Point d'interrogation
                culbut√©</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">,</kbd>
              </div>
            </div>
          </div>

          <!-- Median Dot Hotspot (Point key - Shift+AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--period-centered" aria-label="Point m√©dian">
            <div class="keyboard-tooltip">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">¬∑</span> Point m√©dian</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">Maj</kbd> + <kbd
                  class="keyboard-tooltip__key">.</kbd>
              </div>
            </div>
          </div>

          <!-- Inverted Exclamation Hotspot (Exclamation key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--exclamation-inverted" aria-label="Point d'exclamation culbut√©">
            <div class="keyboard-tooltip keyboard-tooltip--left" style="min-width: 250px;">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">¬°</span> Point d'exclamation
                culbut√©</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">!</kbd>
              </div>
            </div>
          </div>

          <!-- Greater Than or Equal Hotspot (< key - AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--greater-equal" aria-label="Sup√©rieur ou √©gal √†">
            <div class="keyboard-tooltip" style="min-width: 220px;">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">‚â•</span> Sup√©rieur ou √©gal
                √†</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">Maj</kbd> + <kbd
                  class="keyboard-tooltip__key">&lt;</kbd>
              </div>
            </div>
          </div>

          <!-- Less Than or Equal Hotspot (< key - Shift+AltGr position) -->
          <div class="keyboard-hotspot keyboard-hotspot--less-equal" aria-label="Inf√©rieur ou √©gal √†">
            <div class="keyboard-tooltip" style="min-width: 220px;">
              <span class="keyboard-tooltip__title"><span class="keyboard-tooltip__char">‚â§</span> Inf√©rieur ou √©gal
                √†</span>
              <div class="keyboard-tooltip__shortcut" style="display: block; margin-top: var(--space-2);">
                <kbd class="keyboard-tooltip__key">Alt Gr</kbd> + <kbd class="keyboard-tooltip__key">&lt;</kbd>
              </div>
            </div>
          </div>
        </div>


        <div class="hero__actions">
          <button id="open-tester-btn" class="btn btn--success btn--lg">
            <span>‚å®Ô∏è</span>
            Essayer
          </button>
          <a href="download.html" class="btn btn--primary btn--lg">
            <span>‚¨áÔ∏è</span>
            T√©l√©charger
          </a>
          <a href="guide.html" class="btn btn--secondary btn--lg">
            <span>üìñ</span>
            Guide rapide
          </a>
        </div>
      </div>
    </section>

    <!-- Press Section
    <section class="section" style="padding-top: 0; padding-bottom: var(--space-8);">
      <div class="container" style="text-align: center;">
        <p
          style="color: var(--text-muted); font-size: var(--text-sm); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: var(--space-4);">
          Vu dans la presse
        </p>
        <div style="display: flex; justify-content: center; align-items: center; gap: var(--space-8);">
          <a href="https://www.numerama.com/tech/477769-clavier-azerty-ameliore-quest-ce-qui-va-changer.html"
            target="_blank">
            <img src="assets/Logo-numerama.svg" alt="Numerama" class="press-logo" loading="lazy">
          </a>
        </div>
      </div>
    </section> -->

    <!-- Benefits Section -->
    <section class="benefits">
      <div class="container">
        <div class="section__header">
          <h2 class="section__title">Pourquoi AZERTY Global ?</h2>
          <p class="section__subtitle">Un clavier fran√ßais pens√© pour √©crire correctement, sans tout r√©apprendre.</p>
        </div>

        <div class="benefits__grid">
          <article class="card">
            <div class="card__icon">üî§</div>
            <h3 class="card__title">Majuscules accentu√©es</h3>
            <p class="card__text">
              Tapez directement <kbd>√â</kbd>, <kbd>√à</kbd>, <kbd>√Ä</kbd>, <kbd>√á</kbd> avec Verrouillage Majuscule.
              Fini le copier-coller ou les codes ASCII.
            </p>
          </article>

          <article class="card">
            <div class="card__icon">‚ú®</div>
            <h3 class="card__title">Typographie parfaite</h3>
            <p class="card__text">
              Guillemets fran√ßais <kbd>¬´</kbd> <kbd>¬ª</kbd>, tirets cadratins, espaces ins√©cables ‚Äî
              tout est accessible facilement.
            </p>
          </article>

          <article class="card">
            <div class="card__icon">üíª</div>
            <h3 class="card__title">Ami des d√©veloppeurs</h3>
            <p class="card__text">
              Les symboles <kbd>{</kbd> <kbd>}</kbd> <kbd>[</kbd> <kbd>]</kbd> <kbd>|</kbd> <kbd>\</kbd>
              sont sur la rang√©e de repos avec AltGr.
            </p>
          </article>
        </div>
      </div>
    </section>


    <!-- Wow Examples Section -->
    <section class="section">
      <div class="container container--narrow">
        <div class="section__header">
          <h2 class="section__title">Exemples ¬´ Wow ¬ª</h2>
          <p class="section__subtitle">Ce que vous pouvez faire en quelques touches.</p>
        </div>

        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>Caract√®re</th>
                <th>AZERTY Global</th>
                <th>Avant (AZERTY traditionnel)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>.</strong> point</td>
                <td><kbd>.</kbd> <em>(acc√®s direct !)</em> ü§©</td>
                <td>Maj + ; (incompr√©hensible) üò§</td>
              </tr>
              <tr>
                <td><strong>√â</strong> (√© majuscule)</td>
                <td><kbd>Verr. Maj</kbd> + <kbd>√©</kbd> ü§Ø</td>
                <td>Alt + 144 ou copier-coller üò´</td>
              </tr>
              <tr>
                <td><strong>@</strong> arobase</td>
                <td><kbd>@</kbd> <em>(en haut √† gauche)</em> ‚ö°</td>
                <td>AltGr + 0 (inconfortable)</td>
              </tr>
              <tr>
                <td><strong>{ }</strong> accolades</td>
                <td><kbd>AltGr</kbd> + <kbd>D</kbd> / <kbd>F</kbd></td>
                <td>AltGr + 4 / = (un enfer !) üò§</td>
              </tr>
              <tr>
                <td><strong>≈ì</strong> (e dans l'o)</td>
                <td><kbd>AltGr</kbd> + <kbd>O</kbd></td>
                <td>Alt + 0156 ou copier-coller</td>
              </tr>
              <tr>
                <td><strong>¬´ ¬ª</strong> guillemets fran√ßais</td>
                <td><kbd>AltGr</kbd> + <kbd>W</kbd> / <kbd>X</kbd></td>
                <td>Insertion caract√®res sp√©ciaux</td>
              </tr>
              <tr>
                <td>Espace ins√©cable</td>
                <td><kbd>AltGr</kbd> + <kbd>Espace</kbd></td>
                <td>Inexistant</td>
              </tr>
              <tr>
                <td><strong>√°</strong> (espagnol, hongrois...)</td>
                <td><kbd>¬¥</kbd> puis <kbd>A</kbd></td>
                <td>Impossible sans Alt + 0225</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Testimonials (Section d√©sactiv√©e temporairement - sera r√©activ√©e avec de vrais commentaires)
    <section class="section" style="background: var(--bg-secondary);">
      <div class="container">
        <h2 class="section__title" style="text-align: center;">Ils l'ont adopt√©</h2>
        <p class="section__subtitle" style="text-align: center; margin-bottom: var(--space-8);">
          D√©j√† des milliers d'utilisateurs convaincus.
        </p>

        <div class="benefits__grid">
          <div class="card">
            <div style="font-size: var(--text-lg); margin-bottom: var(--space-2);">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
            <p class="card__text" style="font-style: italic; margin-bottom: var(--space-4);">
              "Enfin des majuscules accentu√©es simples ! Je ne peux plus revenir √† l'ancien clavier Windows."
            </p>
            <p style="font-weight: 600; font-size: var(--text-sm);">‚Äî Sophie L., R√©dactrice</p>
          </div>

          <div class="card">
            <div style="font-size: var(--text-lg); margin-bottom: var(--space-2);">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
            <p class="card__text" style="font-style: italic; margin-bottom: var(--space-4);">
              "Indispensable pour coder. Les accolades et crochets sur la rang√©e de repos, c'est un game changer."
            </p>
            <p style="font-weight: 600; font-size: var(--text-sm);">‚Äî Thomas M., D√©veloppeur</p>
          </div>

          <div class="card">
            <div style="font-size: var(--text-lg); margin-bottom: var(--space-2);">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
            <p class="card__text" style="font-style: italic; margin-bottom: var(--space-4);">
              "L'installation est super rapide et on s'habitue en quelques minutes. C'est logique et efficace."
            </p>
            <p style="font-weight: 600; font-size: var(--text-sm);">‚Äî Marc D., √âtudiant</p>
          </div>
        </div>
      </div>
    </section>
    -->

    <!-- Beta Status Section -->
    <section class="beta-status"
      style="background: var(--bg-secondary); border-top: 1px solid var(--border-color); color: var(--text-primary);">
      <div class="container">
        <span class="beta-status__badge" style="background: var(--color-primary); color: white;">Beta</span>
        <p style="opacity: 0.9; margin-bottom: 0;">
          AZERTY Global est en d√©veloppement actif. Vos retours sont pr√©cieux !
        </p>

        <div class="beta-status__info">
          <div class="beta-status__item">
            <span>‚úÖ</span>
            <span>Windows 7/8/10/11 ‚Ä¢ macOS 10.12+</span>
          </div>
          <div class="beta-status__item">
            <span>üîÑ</span>
            <span>Documentation en cours</span>
          </div>
          <div class="beta-status__item">
            <span>üìã</span>
            <span>Mac/Linux √† venir</span>
          </div>
        </div>

        <div style="margin-top: var(--space-6);">
          <a href="feedback.html" class="btn btn--secondary">
            <span>üí¨</span>
            Donner mon avis
          </a>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer__inner">
        <div class="footer__brand">
          <div class="footer__logo">
            <img src="assets/logo-azerty-global.png" alt="Logo AZERTY Global - Disposition clavier am√©lior√©e"
              style="height: 130px; width: auto;">
          </div>
          <p class="footer__tagline">
            L'AZERTY am√©lior√©, pens√© pour le grand public fran√ßais.
          </p>
        </div>

        <div class="footer__links">
          <div class="footer__column">
            <h4>Navigation</h4>
            <ul>
              <li><a href="index.html">Accueil</a></li>
              <li><a href="download.html">T√©l√©charger</a></li>
              <li><a href="guide.html">Guide rapide</a></li>
              <li><a href="comparatif.html">Comparatif</a></li>
              <li><a href="feedback.html">Feedback</a></li>
            </ul>
          </div>

          <div class="footer__column">
            <h4>Ressources</h4>
            <ul>
              <li><a href="images/carte-complete.svg" target="_blank">Carte compl√®te</a></li>
              <li><a href="images/carte-simplifiee.svg" target="_blank">Carte simplifi√©e</a></li>
              <li><a href="https://github.com/AZERTYGlobal/website" target="_blank">GitHub</a></li>
            </ul>
          </div>

          <div class="footer__column">
            <h4>Contact</h4>
            <ul>
              <li><a href="mailto:contact@azerty.global">Email</a></li>
              <li><a href="https://discord.gg/nYknqshJz3" target="_blank">Discord</a></li>
              <li><a href="https://www.paypal.com/paypalme/azertyglobal" target="_blank"
                  style="color: var(--color-accent); font-weight: 600;">Faire un don ‚ù§Ô∏è</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="footer__bottom">
        <span>¬© 2017‚Äì2026 AZERTY Global ‚Äî Antoine OLIVIER</span>
        <span>
          <a href="mentions-legales.html" style="color: inherit; text-decoration: none;">Mentions L√©gales</a> ‚Ä¢
          Fait avec ‚ù§Ô∏è pour les Fran√ßais
        </span>
      </div>
    </div>
  </footer>

  <!-- Keyboard Tester Modal -->
  <div id="tester-modal" class="tester-modal" style="display: none;">
    <div class="tester-modal__overlay"></div>
    <div class="tester-modal__content">
      <button class="tester-modal__close" aria-label="Fermer">&times;</button>

      <!-- All content wrapped in keyboard-wrapper so keyboard defines width -->
      <div class="tester-modal__keyboard-wrapper">
        <!-- Mode Tabs -->
        <div class="modal-tabs" style="display: flex; gap: 8px; margin-bottom: 12px;">
          <button id="tab-libre" class="modal-tab modal-tab--active"
            style="flex: 1; padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; background: var(--color-accent); color: var(--color-primary-dark);">
            ‚å®Ô∏è Libre
          </button>
          <button id="tab-lessons" class="modal-tab"
            style="flex: 1; padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; background: var(--bg-secondary); color: var(--text-primary);">
            üéì Le√ßons
          </button>
        </div>

        <!-- Libre Mode Content -->
        <div id="mode-libre" class="modal-mode">
          <!-- Character Search (at top) -->
          <div class="modal-search-container" style="position: relative; width: 100%; margin-bottom: 12px;">
            <input type="text" id="modal-search-input" class="modal-search-input"
              placeholder="üîç Rechercher un caract√®re..." autocomplete="off"
              style="width: 100%; padding: 12px 15px; font-size: 16px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); outline: none; box-sizing: border-box;">
            <div class="modal-search-results" id="modal-search-results" hidden
              style="position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; max-height: 200px; overflow-y: auto; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100;">
            </div>
          </div>

          <div class="tester-modal__output">
            <div id="modal-output" class="output-text" contenteditable="true"
              data-placeholder="Tapez au clavier ou cliquez sur les touches..."></div>
          </div>
        </div>

        <!-- Lessons Mode Content -->
        <div id="mode-lessons" class="modal-mode" style="display: none;">
          <!-- Lesson Navigation -->
          <div id="lesson-nav" style="margin-bottom: 12px;">
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
              <select id="lesson-module-select"
                style="flex: 1; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; cursor: pointer;">
                <option value="">Choisir un module...</option>
              </select>
            </div>
            <div id="lesson-list" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
          </div>

          <!-- Exercise Area -->
          <div id="lesson-exercise" style="display: none;">
            <div
              style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span id="lesson-title" style="font-weight: 600; color: var(--text-primary);"></span>
                <span id="lesson-progress" style="font-size: 12px; color: var(--text-secondary);"></span>
              </div>
              <p id="lesson-instruction" style="font-size: 13px; color: var(--text-secondary); margin: 0 0 12px 0;"></p>

              <!-- Target text to type -->
              <div id="lesson-target"
                style="font-family: monospace; font-size: 18px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; margin-bottom: 8px; white-space: pre-wrap; line-height: 1.6;">
              </div>

              <!-- User input -->
              <div id="lesson-input" class="output-text" contenteditable="true" data-placeholder="Tapez ici..."
                style="font-family: monospace; font-size: 18px; background: var(--bg-card); border: 2px solid var(--color-accent); border-radius: 6px; padding: 12px; min-height: 1.5em; outline: none;">
              </div>
            </div>

            <div style="display: flex; gap: 8px;">
              <button id="lesson-prev"
                style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;">‚Üê
                Pr√©c√©dent</button>
              <button id="lesson-restart"
                style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;">üîÑ
                Recommencer</button>
              <button id="lesson-hint"
                style="padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;">üí°
                Indice</button>
              <button id="lesson-next"
                style="flex: 1; padding: 8px 16px; border: none; border-radius: 6px; background: var(--color-accent); color: var(--color-primary-dark); font-weight: 600; cursor: pointer;">Suivant
                ‚Üí</button>
            </div>
          </div>

          <!-- Welcome screen when no lesson selected -->
          <div id="lesson-welcome" style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; margin-bottom: 12px;">üéì</div>
            <h3 style="margin: 0 0 8px 0; color: var(--text-primary);">Apprenez AZERTY Global</h3>
            <p style="color: var(--text-secondary); margin: 0;">Choisissez un module ci-dessus pour commencer</p>
          </div>
        </div>

        <!-- Keyboard inside wrapper to define width -->
        <div id="modal-keyboard-container" class="keyboard-container" style="margin-top: 12px;"></div>
      </div>

      <div class="status-bar">
        <span class="status-item" id="modal-status-shift">‚óè Maj.</span>
        <span class="status-item" id="modal-status-caps">‚óè Verr. Maj.</span>
        <span class="status-item" id="modal-status-altgr">‚óè AltGr</span>
        <span class="status-item" id="modal-status-deadkey">‚óè Touche morte : <span
            id="modal-deadkey-name">-</span></span>
      </div>
    </div>
  </div>

  <style>
    /* Tester Modal Styles */
    .tester-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tester-modal__overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
    }

    .tester-modal__content {
      position: relative;
      background: var(--bg-primary);
      border-radius: 16px;
      padding: var(--space-3);
      max-width: 95vw;
      width: fit-content;
      max-height: 95vh;
      overflow: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    .tester-modal__close {
      position: absolute;
      top: var(--space-3);
      right: var(--space-3);
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: var(--text-secondary);
      line-height: 1;
      padding: var(--space-1);
      transition: color 0.2s;
    }

    .tester-modal__close:hover {
      color: var(--text-primary);
    }

    .tester-modal__keyboard-wrapper {
      display: flex;
      flex-direction: column;
      width: fit-content;
    }

    .tester-modal__output {
      width: fit-content;
      min-width: 100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px 15px;
      margin-bottom: var(--space-2);
      box-sizing: border-box;
    }

    .tester-modal .output-text {
      font-size: 18px;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
      overflow-wrap: break-word;
      overflow-y: auto;
      overflow-x: hidden;
      max-height: 3.9em;
      line-height: 1.3;
      outline: none;
      min-height: 1.3em;
      caret-color: var(--color-primary);
      width: 0;
      min-width: 100%;
    }

    .tester-modal .output-text:empty::before {
      content: attr(data-placeholder);
      color: var(--text-muted);
    }

    .tester-modal .status-bar {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      justify-content: center;
      margin-top: var(--space-4);
      font-size: var(--text-sm);
      color: var(--text-muted);
    }

    .tester-modal .status-item {
      opacity: 0.5;
    }

    .tester-modal .status-item.on {
      opacity: 1;
      color: var(--color-primary);
    }

    .tester-modal .keyboard-container {
      border: none;
      box-shadow: none;
      background: transparent;
    }
  </style>

  <!-- Scripts -->
  <script src="js/layout-data.js"></script>
  <script src="js/app.js"></script>
  <script src="js/easter-eggs.js"></script>
  <script type="module">
    import { AZERTYKeyboard } from './tester/keyboard.js';
    // Mobile tap behavior for keyboard preview
    (function () {
      const keyboard = document.querySelector('.hero__keyboard');
      if (!keyboard) return;

      // On touch devices: tap to open, tap outside to close
      keyboard.addEventListener('click', function (e) {
        if (window.matchMedia('(hover: none)').matches) {
          e.stopPropagation();
          this.classList.add('is-full');
        }
      });

      // Close when tapping outside
      document.addEventListener('click', function (e) {
        if (window.matchMedia('(hover: none)').matches) {
          if (!keyboard.contains(e.target)) {
            keyboard.classList.remove('is-full');
          }
        }
      });
    })();

    // Keyboard Tester Modal
    (function () {
      const modal = document.getElementById('tester-modal');
      const openBtn = document.getElementById('open-tester-btn');
      const closeBtn = modal.querySelector('.tester-modal__close');
      const overlay = modal.querySelector('.tester-modal__overlay');
      const outputEl = document.getElementById('modal-output');
      let keyboard = null;

      // Lesson state (declared early for onKeyClick access)
      let currentMode = 'libre';
      let currentLessonIndex = -1;

      const DEAD_KEY_NAMES_FR = {
        'dk_circumflex': 'Circonflexe',
        'dk_diaeresis': 'Tr√©ma',
        'dk_acute': 'Accent aigu',
        'dk_grave': 'Accent grave',
        'dk_tilde': 'Tilde',
        'dk_dot_above': 'Point en chef',
        'dk_dot_below': 'Point souscrit',
        'dk_double_acute': 'Double accent aigu',
        'dk_double_grave': 'Double accent grave',
        'dk_horn': 'Corne',
        'dk_hook': 'Crochet',
        'dk_caron': 'Caron',
        'dk_ogonek': 'Ogonek',
        'dk_breve': 'Br√®ve',
        'dk_inverted_breve': 'Br√®ve invers√©e',
        'dk_stroke': 'Barre oblique',
        'dk_horizontal_stroke': 'Barre horizontale',
        'dk_macron': 'Macron',
        'dk_extended_latin': 'Latin √©tendu',
        'dk_cedilla': 'C√©dille',
        'dk_comma': 'Virgule souscrite',
        'dk_phonetic': 'Alphabet phon√©tique',
        'dk_ring_above': 'Rond en chef',
        'dk_greek': 'Alphabet grec',
        'dk_cyrillic': 'Alphabet cyrillique',
        'dk_misc_symbols': 'Symboles divers',
        'dk_scientific': 'Symboles scientifiques',
        'dk_currencies': 'Symboles mon√©taires',
        'dk_punctuation': 'Symboles de ponctuation'
      };

      function openModal() {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        if (!keyboard) {
          keyboard = new AZERTYKeyboard('#modal-keyboard-container', {
            layoutUrl: 'tester/azerty-global.json',
            onKeyClick: (char, keyId) => {
              // Determine target element based on current mode
              const targetEl = (currentMode === 'lessons' && currentLessonIndex >= 0)
                ? document.getElementById('lesson-input')
                : outputEl;

              const selection = window.getSelection();
              if (selection.rangeCount > 0 && targetEl.contains(selection.anchorNode)) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(char));
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
              } else {
                targetEl.textContent += char;
              }
              targetEl.scrollTop = targetEl.scrollHeight;

              // Trigger input event for lesson mode feedback
              if (targetEl.id === 'lesson-input') {
                targetEl.dispatchEvent(new Event('input'));
              }
            },
            onStateChange: (state) => {
              document.getElementById('modal-status-shift').classList.toggle('on', state.shift);
              document.getElementById('modal-status-caps').classList.toggle('on', state.caps);
              document.getElementById('modal-status-altgr').classList.toggle('on', state.altgr);
              document.getElementById('modal-status-deadkey').classList.toggle('on', !!state.activeDeadKey);

              const dkName = state.activeDeadKey
                ? (DEAD_KEY_NAMES_FR[state.activeDeadKey] || state.activeDeadKey)
                : '-';
              document.getElementById('modal-deadkey-name').textContent = dkName;

              // Refresh tooltips after keyboard display updates
              setTimeout(() => createModalCharacterTooltips(), 50);
            }
          });

          // Add platform selector buttons to status bar
          setTimeout(() => {
            const statusBar = document.querySelector('.tester-modal .status-bar');
            if (statusBar && !document.querySelector('.platform-selector')) {
              const platformSelector = document.createElement('div');
              platformSelector.className = 'platform-selector';
              platformSelector.style.cssText = 'display: flex; gap: 6px; margin-left: auto;';

              const platforms = [
                { id: 'windows', label: 'ü™ü Windows', value: 'windows' },
                { id: 'mac', label: 'üçé macOS', value: 'mac' },
                { id: 'linux', label: 'üêß Linux', value: 'linux' }
              ];

              platforms.forEach(platform => {
                const btn = document.createElement('button');
                btn.className = 'platform-btn';
                btn.dataset.platform = platform.value;
                btn.textContent = platform.label;
                btn.style.cssText = 'padding: 4px 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-muted); border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s; opacity: 0.5;';

                // Detect current platform and set active
                const detectedPlatform = typeof navigator !== 'undefined'
                  ? (/Mac|iPhone|iPad|iPod/.test(navigator.platform) ? 'mac'
                    : /Linux/.test(navigator.platform) ? 'linux'
                      : 'windows')
                  : 'windows';

                if (platform.value === detectedPlatform) {
                  btn.style.opacity = '1';
                  btn.style.color = 'var(--color-primary)';
                  btn.style.borderColor = 'var(--color-primary)';
                }

                btn.addEventListener('click', () => {
                  // Update all buttons
                  document.querySelectorAll('.platform-btn').forEach(b => {
                    b.style.opacity = '0.5';
                    b.style.color = 'var(--text-muted)';
                    b.style.borderColor = 'var(--border-color)';
                  });

                  // Highlight selected
                  btn.style.opacity = '1';
                  btn.style.color = 'var(--color-primary)';
                  btn.style.borderColor = 'var(--color-primary)';

                  // Update keyboard
                  keyboard.setPlatform(platform.value);

                  // Update AltGr label based on platform
                  const altgrLabel = document.getElementById('modal-status-altgr');
                  if (altgrLabel) {
                    altgrLabel.textContent = platform.value === 'mac' ? '‚óè Option' : '‚óè AltGr';
                  }
                });

                platformSelector.appendChild(btn);
              });

              statusBar.appendChild(platformSelector);
            }
          }, 100);



          // Sync output and search widths with keyboard after layout loads
          setTimeout(() => {
            const keyboardEl = document.querySelector('#modal-keyboard-container .azerty-keyboard');
            const outputEl = document.querySelector('.tester-modal__output');
            const searchContainer = document.querySelector('.modal-search-container');
            if (keyboardEl && outputEl) {
              const kbWidth = keyboardEl.offsetWidth + 'px';
              outputEl.style.width = kbWidth;
              outputEl.style.maxWidth = kbWidth;
              if (searchContainer) {
                searchContainer.style.width = kbWidth;
                searchContainer.style.maxWidth = kbWidth;
              }
            }
          }, 100);
        }

        // Mobile detection and virtual keyboard prevention
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        let hasPhysicalKeyboard = false;

        if (isMobile) {
          // Get all input elements in the tester
          const searchInput = document.getElementById('modal-search-input');
          const lessonInput = document.getElementById('lesson-input');
          
          // Prevent virtual keyboard by using inputmode and preventing focus
          const preventVirtualKeyboard = (el) => {
            if (el) {
              el.setAttribute('inputmode', 'none');
              // Blur immediately if focused (prevents keyboard from opening)
              el.addEventListener('focus', (e) => {
                if (!hasPhysicalKeyboard) {
                  e.target.blur();
                }
              });
            }
          };
          
          preventVirtualKeyboard(outputEl);
          preventVirtualKeyboard(searchInput);
          preventVirtualKeyboard(lessonInput);
          
          // Add warning message for mobile users
          const existingWarning = modal.querySelector('.mobile-keyboard-warning');
          if (!existingWarning) {
            const warning = document.createElement('div');
            warning.className = 'mobile-keyboard-warning';
            warning.style.cssText = 'background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(249, 115, 22, 0.15) 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center;';
            warning.innerHTML = `
              <div style="font-size: 1.5rem; margin-bottom: 8px;">‚ö†Ô∏è</div>
              <div style="font-weight: 600; margin-bottom: 8px; color: #f59e0b;">Clavier physique requis</div>
              <div style="font-size: 14px; color: var(--text-secondary);">
                Le testeur n√©cessite un clavier physique (USB ou Bluetooth).<br>
                Connectez un clavier pour utiliser le testeur.
              </div>
            `;
            
            const modalContent = modal.querySelector('.tester-modal__content');
            modalContent.insertBefore(warning, modalContent.firstChild);
          }

          // Detect physical keyboard on first keydown
          const detectPhysicalKeyboard = (e) => {
            if (e.code && !hasPhysicalKeyboard) {
              hasPhysicalKeyboard = true;
              
              // Remove inputmode from all inputs
              if (outputEl) outputEl.removeAttribute('inputmode');
              if (searchInput) searchInput.removeAttribute('inputmode');
              if (lessonInput) lessonInput.removeAttribute('inputmode');
              
              // Remove warning
              const warning = modal.querySelector('.mobile-keyboard-warning');
              if (warning) {
                warning.style.transition = 'opacity 0.3s';
                warning.style.opacity = '0';
                setTimeout(() => warning.remove(), 300);
              }
              
              // Focus the output element now that physical keyboard is detected
              outputEl.focus();
              
              // Remove this listener after detection
              document.removeEventListener('keydown', detectPhysicalKeyboard);
            }
          };
          
          document.addEventListener('keydown', detectPhysicalKeyboard);
          
          // Don't auto-focus on mobile without physical keyboard
          return;
        }

        outputEl.focus();
      }

      function closeModal() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }

      /**
       * Remap Mac key codes to match Windows/Linux layout
       * On Mac, Backquote (E00) and IntlBackslash (B00) are physically swapped
       */
      function remapMacKeyCode(code) {
        // Only remap when Mac platform is detected
        const isMac = /Mac|iPhone|iPad|iPod/.test(navigator.platform);
        if (!isMac) return code;
        
        // Swap E00 ‚Üî B00 to match Windows/Linux physical layout
        if (code === 'Backquote') return 'IntlBackslash';
        if (code === 'IntlBackslash') return 'Backquote';
        
        return code;
      }

      openBtn.addEventListener('click', openModal);
      closeBtn.addEventListener('click', closeModal);
      overlay.addEventListener('click', closeModal);

      document.addEventListener('keydown', (e) => {
        if (modal.style.display === 'flex') {
          if (e.code === 'Escape') {
            closeModal();
            e.preventDefault();
            return;
          }

          // Handle keyboard input in modal
          if (keyboard) {
            // Remap Mac key codes to match Windows/Linux layout
            const keyCode = remapMacKeyCode(e.code);
            
            keyboard.pressKey(keyCode);

            if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
              keyboard.setShift(true);
              e.preventDefault();
              return;
            }
            if (e.code === 'CapsLock') {
              // Read actual Caps Lock state from browser (works correctly on all platforms)
              const capsLockActive = e.getModifierState('CapsLock');
              keyboard.setCaps(capsLockActive);
              e.preventDefault();
              return;
            }
            if (e.code === 'AltRight') {
              keyboard.setAltGr(true);
              e.preventDefault();
              return;
            }
            // Allow Ctrl shortcuts, but not when AltGr is pressed (Windows quirk)
            if ((e.ctrlKey && !e.altKey) || e.metaKey) {
              return;
            }
            if (e.code === 'AltLeft') {
              e.preventDefault();
              return;
            }
            if (e.code === 'ArrowUp' || e.code === 'ArrowDown' || e.code === 'ArrowLeft' || e.code === 'ArrowRight') {
              return;
            }
            if (e.code === 'Backspace') {
              if (keyboard.state?.activeDeadKey) {
                keyboard.clearDeadKey();
              } else {
                document.execCommand('delete', false);
              }
              e.preventDefault();
              return;
            }
            if (e.code === 'Delete') {
              if (keyboard.state?.activeDeadKey) {
                keyboard.clearDeadKey();
                e.preventDefault();
              }
              // If no dead key, let default browser behavior handle the deletion
              return;
            }
            if (e.code === 'Enter') {
              document.execCommand('insertLineBreak', false);
              outputEl.scrollTop = outputEl.scrollHeight;
              e.preventDefault();
              return;
            }

            keyboard.handleKeyClick(keyCode, true); // skipAutoRelease=true for physical keyboard
            e.preventDefault();
          }
        }
      });

      document.addEventListener('keyup', (e) => {
        if (modal.style.display === 'flex' && keyboard) {
          keyboard.releaseKey(e.code);
          if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
            keyboard.setShift(false);
          }
          if (e.code === 'AltRight') {
            keyboard.setAltGr(false);
          }
        }
      });

      // Block native text input in modal - we handle all character input through the keyboard
      outputEl.addEventListener('beforeinput', (e) => {
        if (e.inputType === 'insertText' || e.inputType === 'insertCompositionText') {
          e.preventDefault();
        }
      });

      // Clean output element when empty so placeholder reappears
      outputEl.addEventListener('input', () => {
        // Remove any leftover <br> or whitespace to make :empty work
        if (outputEl.textContent.trim() === '') {
          outputEl.innerHTML = '';
        }
      });

      // ========================================
      // Character Search Functionality
      // ========================================

      let characterIndex = null;
      const searchInput = document.getElementById('modal-search-input');
      const searchResults = document.getElementById('modal-search-results');
      let searchDebounceTimer = null;
      let highlightTimeouts = [];

      // Load character index
      async function loadCharacterIndex() {
        try {
          const response = await fetch('tester/character-index.json');
          if (!response.ok) throw new Error('Failed to load character index');
          characterIndex = await response.json();
          console.log(`Character index loaded: ${characterIndex.totalCharacters} characters`);
        } catch (error) {
          console.error('Error loading character index:', error);
        }
      }

      // Load on first modal open
      openBtn.addEventListener('click', async () => {
        if (!characterIndex) {
          await loadCharacterIndex();
          setTimeout(() => createModalCharacterTooltips(), 100);
        }
      }, { once: true });

      // Create tooltips showing character names on hover
      function createModalCharacterTooltips() {
        if (!characterIndex) return;

        // Dead key symbols to French names mapping
        const deadKeySymbolNames = {
          '^': 'Touche morte circonflexe',
          '¬®': 'Touche morte tr√©ma',
          '¬¥': 'Touche morte accent aigu',
          '`': 'Touche morte accent grave',
          '~': 'Touche morte tilde',
          'Àá': 'Touche morte caron',
          'Àõ': 'Touche morte ogonek',
          'Àô': 'Touche morte point en chef',
          'Àù': 'Touche morte double accent aigu',
          'Àò': 'Touche morte br√®ve',
          '¬Ø': 'Touche morte macron',
          '¬∏': 'Touche morte c√©dille',
          'Àö': 'Touche morte rond en chef',
          '¬§': 'Touche morte monnaies',
          '¬±': 'Touche morte scientifique',
          '‚Üí': 'Touche morte symboles divers',
          'Œº': 'Touche morte grec',
          '—è': 'Touche morte cyrillique',
          '¬ß': 'Touche morte ponctuation',
          ' Å': 'Touche morte phon√©tique',
          '…ô': 'Touche morte latin √©tendu'
        };

        // Add title attribute to each character span
        document.querySelectorAll('#modal-keyboard-container .key .key-char').forEach(charSpan => {
          const char = charSpan.textContent.trim();
          if (!char || char.length === 0) return;

          // Check dead key symbols first
          if (deadKeySymbolNames[char]) {
            charSpan.title = deadKeySymbolNames[char];
            charSpan.style.cursor = 'help';
            return;
          }

          // Look up character in index
          const charData = characterIndex.characters[char];
          if (charData) {
            const name = charData.unicodeNameFr || charData.unicodeName || char;
            charSpan.title = name;
            charSpan.style.cursor = 'help';
          }
        });
      }

      // Normalize text for search (remove accents, lowercase)
      function normalizeForSearch(text) {
        if (!text) return '';
        return text.normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .toLowerCase();
      }

      // Search characters
      function searchCharacters(query) {
        if (!characterIndex || !query || query.length < 1) return [];

        const normalizedQuery = normalizeForSearch(query);
        const queryWords = normalizedQuery.split(/\s+/).filter(w => w.length > 0);
        const originalQueryWords = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
        const results = [];

        for (const [char, data] of Object.entries(characterIndex.characters)) {
          let score = 0;

          // Exact character match (highest priority)
          if (char === query) {
            score = 100;
          }
          // Character match (case-insensitive)
          else if (char.toLowerCase() === query.toLowerCase()) {
            score = 90;
          }
          // French alias match
          else if (data.frenchAliases && data.frenchAliases.some(alias => {
            const aliasWords = normalizeForSearch(alias).split(/\s+/);
            return queryWords.every(qw => aliasWords.some(aw => aw === qw || aw.startsWith(qw)));
          })) {
            score = 80;
          }
          // French name contains all query words
          else if (data.unicodeNameFr) {
            const nameWords = normalizeForSearch(data.unicodeNameFr).split(/\s+/);
            if (queryWords.every(qw => nameWords.some(nw => nw === qw || nw.startsWith(qw)))) {
              score = 70;
            }
          }
          // Unicode name contains all query words
          if (score === 0 && data.unicodeName) {
            const nameWords = normalizeForSearch(data.unicodeName).split(/\s+/);
            if (queryWords.every(qw => nameWords.some(nw => nw === qw || nw.startsWith(qw)))) {
              score = 50;
            }
          }

          if (score > 0) {
            // Bonus for basic Latin
            const codePointNum = parseInt(data.codePoint.replace('U+', ''), 16);
            if (codePointNum >= 0x0020 && codePointNum <= 0x007F) {
              score += 15;
            }
            // Bonus if character matches query word
            if (queryWords.some(word => normalizeForSearch(char) === word)) {
              score += 10;
            }
            // Bonus for exact accent match (the typed character is the result)
            const lowerChar = char.toLowerCase();
            if (originalQueryWords.includes(lowerChar) || originalQueryWords.includes(char)) {
              score += 50;
            }
            // Massive bonus for exact single character search
            if (originalQueryWords.length === 1 && originalQueryWords[0].length === 1 &&
              (char === originalQueryWords[0] || char.toLowerCase() === originalQueryWords[0].toLowerCase())) {
              score += 100;
            }
            // Bonus for dead key activation characters (dk:name)
            if (char.startsWith('dk:')) {
              score += 30;
            }
            results.push({ char, data, score });
          }
        }

        // Sort by score
        results.sort((a, b) => {
          if (b.score !== a.score) return b.score - a.score;
          return a.data.codePoint.localeCompare(b.data.codePoint);
        });

        // Smart cutoff: only show results with score >= 50% of top score
        const topScore = results.length > 0 ? results[0].score : 0;
        const filteredResults = results.filter(r => r.score >= topScore * 0.5);

        return filteredResults;
      }

      // Format method for display
      function formatSearchMethod(method) {
        const keyNames = {
          'Digit1': '1', 'Digit2': '2', 'Digit3': '3', 'Digit4': '4', 'Digit5': '5',
          'Digit6': '6', 'Digit7': '7', 'Digit8': '8', 'Digit9': '9', 'Digit0': '0',
          'KeyQ': 'A', 'KeyW': 'Z', 'KeyE': 'E', 'KeyR': 'R', 'KeyT': 'T', 'KeyY': 'Y',
          'KeyU': 'U', 'KeyI': 'I', 'KeyO': 'O', 'KeyP': 'P', 'KeyA': 'Q', 'KeyS': 'S',
          'KeyD': 'D', 'KeyF': 'F', 'KeyG': 'G', 'KeyH': 'H', 'KeyJ': 'J', 'KeyK': 'K',
          'KeyL': 'L', 'KeyZ': 'W', 'KeyX': 'X', 'KeyC': 'C', 'KeyV': 'V', 'KeyB': 'B',
          'KeyN': 'N', 'KeyM': ',', 'Semicolon': 'M', 'Comma': ';', 'Period': ':',
          'Slash': '!', 'Backquote': '@', 'BracketLeft': '^', 'BracketRight': '$',
          'Backslash': '*', 'Equal': '=', 'Minus': ')', 'IntlBackslash': '<',
          'Space': 'Espace', 'Quote': '√ô'
        };

        const keyName = keyNames[method.key] || method.key;

        if (method.type === 'direct') {
          if (method.layer === 'Base') return keyName;
          if (method.layer === 'Caps') return `Verr. Maj. + ${keyName}`;
          if (method.layer === 'Shift') return `Maj + ${keyName}`;
          if (method.layer === 'Caps+Shift') return `Verr. Maj. + Maj + ${keyName}`;
          if (method.layer === 'AltGr') return `AltGr + ${keyName}`;
          if (method.layer === 'Caps+AltGr') return `Verr. Maj. + AltGr + ${keyName}`;
          if (method.layer === 'Shift+AltGr') return `Maj + AltGr + ${keyName}`;
          if (method.layer === 'Caps+Shift+AltGr') return `Verr. Maj. + Maj + AltGr + ${keyName}`;
        } else if (method.type === 'deadkey') {
          const dkName = DEAD_KEY_NAMES_FR[method.deadkey] || method.deadkey;
          let baseKey = keyName;
          if (method.layer.includes('Shift')) {
            baseKey = `Maj + ${keyName}`;
          }
          return `${dkName} puis ${baseKey}`;
        } else if (method.type === 'deadkey_activation') {
          if (method.layer === 'Base') return keyName;
          if (method.layer === 'Shift') return `Maj + ${keyName}`;
          if (method.layer === 'AltGr') return `AltGr + ${keyName}`;
          if (method.layer === 'Shift+AltGr') return `Maj + AltGr + ${keyName}`;
        }

        return keyName;
      }

      // Display search results
      function displaySearchResults(results) {
        if (results.length === 0) {
          searchResults.innerHTML = '<div style="padding: 15px; color: var(--text-secondary); text-align: center;">Aucun r√©sultat</div>';
          searchResults.hidden = false;
          return;
        }

        searchResults.innerHTML = results.map((result, index) => {
          const methods = result.data.methods;
          const recommendedMethod = methods.find(m => m.recommended) || methods[0];

          // Check for shortcut + canonical method
          const shortcutMethod = methods.find(m =>
            m.type === 'deadkey' && (m.deadkey === 'dk_circumflex' || m.deadkey === 'dk_acute')
          );
          const canonicalMethod = methods.find(m =>
            m.type === 'deadkey' && m.deadkey !== 'dk_circumflex' && m.deadkey !== 'dk_acute'
          );

          let methodText;
          if (shortcutMethod && canonicalMethod && shortcutMethod !== canonicalMethod) {
            methodText = `${formatSearchMethod(shortcutMethod)} ou ${formatSearchMethod(canonicalMethod)}`;
          } else {
            methodText = formatSearchMethod(recommendedMethod);
          }

          const name = result.data.unicodeNameFr || result.data.unicodeName || '';

          return `
            <div class="modal-search-result-item" data-index="${index}" style="display: flex; align-items: center; gap: 12px; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color);">
              <span style="font-size: 28px; font-weight: 500; min-width: 40px; text-align: center; color: var(--color-accent);">${result.data.displayChar || result.char}</span>
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 14px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${methodText}</div>
              </div>
            </div>
          `;
        }).join('');

        // Add click handlers
        searchResults.querySelectorAll('.modal-search-result-item').forEach((item, idx) => {
          item.addEventListener('click', () => {
            const result = results[idx];
            const method = result.data.methods.find(m => m.recommended) || result.data.methods[0];
            highlightSearchMethod(method);
            searchResults.hidden = true;
            searchInput.value = '';
            searchInput.blur();
            // Focus output area so typed text goes there
            document.getElementById('modal-output').focus();
          });
        });

        searchResults.hidden = false;
      }

      // Clear all highlights
      function clearSearchHighlights() {
        highlightTimeouts.forEach(t => clearTimeout(t));
        highlightTimeouts = [];
        document.querySelectorAll('.key.search-highlight, .key.search-highlight-step1, .key.search-highlight-step2').forEach(key => {
          key.classList.remove('search-highlight', 'search-highlight-step1', 'search-highlight-step2');
        });
      }

      // Highlight a key
      function highlightSearchKey(keyId, className = 'search-highlight') {
        const keyEl = document.querySelector(`#modal-keyboard-container .key[data-key-id="${keyId}"]`);
        if (keyEl) {
          keyEl.classList.add(className);
        }
      }

      // Get dead key key ID
      function getSearchDeadKeyKeyId(deadkey) {
        const deadKeyMapping = {
          'dk_circumflex': 'BracketLeft', 'dk_diaeresis': 'BracketLeft', 'dk_acute': 'Quote',
          'dk_grave': 'Quote', 'dk_tilde': 'Quote', 'dk_dot_above': 'Digit1',
          'dk_dot_below': 'Digit1', 'dk_double_acute': 'Digit2', 'dk_double_grave': 'Digit2',
          'dk_horn': 'Digit3', 'dk_hook': 'Digit3', 'dk_caron': 'BracketLeft',
          'dk_ogonek': 'BracketLeft', 'dk_breve': 'Digit5', 'dk_inverted_breve': 'Digit5',
          'dk_stroke': 'Digit7', 'dk_horizontal_stroke': 'Digit7', 'dk_macron': 'Digit8',
          'dk_extended_latin': 'Digit8', 'dk_cedilla': 'Digit9', 'dk_comma': 'Digit9',
          'dk_phonetic': 'Digit0', 'dk_ring_above': 'Minus', 'dk_greek': 'Backslash',
          'dk_cyrillic': 'Backslash', 'dk_misc_symbols': 'Backquote',
          'dk_scientific': 'Equal', 'dk_currencies': 'BracketRight',
          'dk_punctuation': 'Slash'
        };
        return deadKeyMapping[deadkey] || 'BracketLeft';
      }

      // Highlight method with animation
      function highlightSearchMethod(method) {
        clearSearchHighlights();

        if (method.type === 'direct') {
          highlightSearchKey(method.key, 'search-highlight');

          if (method.layer.includes('Caps')) {
            highlightSearchKey('CapsLock', 'search-highlight');
          }
          if (method.layer.includes('Shift')) {
            highlightSearchKey('ShiftLeft', 'search-highlight');
            highlightSearchKey('ShiftRight', 'search-highlight');
          }
          if (method.layer.includes('AltGr')) {
            highlightSearchKey('AltRight', 'search-highlight');
          }

          highlightTimeouts.push(setTimeout(clearSearchHighlights, 2500));

        } else if (method.type === 'deadkey') {
          // Step 1: Dead key (orange)
          const deadKeyId = getSearchDeadKeyKeyId(method.deadkey);
          highlightSearchKey(deadKeyId, 'search-highlight-step1');

          const needsShift = ['dk_diaeresis', 'dk_grave', 'dk_punctuation', 'dk_greek'].includes(method.deadkey);
          const needsAltGr = ['dk_caron', 'dk_tilde', 'dk_dot_above', 'dk_double_acute', 'dk_horn', 'dk_breve', 'dk_stroke', 'dk_macron', 'dk_cedilla', 'dk_scientific', 'dk_currencies', 'dk_cyrillic', 'dk_misc_symbols'].includes(method.deadkey);
          const needsShiftAltGr = ['dk_ogonek', 'dk_dot_below', 'dk_double_grave', 'dk_hook', 'dk_inverted_breve', 'dk_horizontal_stroke', 'dk_extended_latin', 'dk_comma', 'dk_phonetic', 'dk_ring_above'].includes(method.deadkey);

          if (needsShiftAltGr) {
            highlightSearchKey('ShiftLeft', 'search-highlight-step1');
            highlightSearchKey('ShiftRight', 'search-highlight-step1');
            highlightSearchKey('AltRight', 'search-highlight-step1');
          } else if (needsShift) {
            highlightSearchKey('ShiftLeft', 'search-highlight-step1');
            highlightSearchKey('ShiftRight', 'search-highlight-step1');
          } else if (needsAltGr) {
            highlightSearchKey('AltRight', 'search-highlight-step1');
          }

          // Step 2: Base key (green)
          highlightTimeouts.push(setTimeout(() => {
            clearSearchHighlights();
            highlightSearchKey(method.key, 'search-highlight-step2');

            if (method.layer.includes('Shift')) {
              highlightSearchKey('ShiftLeft', 'search-highlight-step2');
              highlightSearchKey('ShiftRight', 'search-highlight-step2');
            }

            highlightTimeouts.push(setTimeout(clearSearchHighlights, 2500));
          }, 2500));
        } else if (method.type === 'deadkey_activation') {
          // Just highlight the dead key itself
          const deadKeyId = getSearchDeadKeyKeyId(method.deadkey);
          highlightSearchKey(deadKeyId, 'search-highlight');

          // Highlight modifiers based on layer
          if (method.layer.includes('Shift') && method.layer.includes('AltGr')) {
            highlightSearchKey('ShiftLeft', 'search-highlight');
            highlightSearchKey('ShiftRight', 'search-highlight');
            highlightSearchKey('AltRight', 'search-highlight');
          } else if (method.layer.includes('Shift')) {
            highlightSearchKey('ShiftLeft', 'search-highlight');
            highlightSearchKey('ShiftRight', 'search-highlight');
          } else if (method.layer.includes('AltGr')) {
            highlightSearchKey('AltRight', 'search-highlight');
          }

          highlightTimeouts.push(setTimeout(clearSearchHighlights, 2500));
        }
      }

      // Search input handler
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();

        clearTimeout(searchDebounceTimer);

        if (query.length === 0) {
          searchResults.hidden = true;
          clearSearchHighlights();
          return;
        }

        searchDebounceTimer = setTimeout(() => {
          const results = searchCharacters(query);
          displaySearchResults(results);
        }, 150);
      });

      // Close search on click outside
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
          searchResults.hidden = true;
        }
      });

      // Prevent keyboard processing when search is focused
      searchInput.addEventListener('keydown', (e) => {
        e.stopPropagation();
      });

      // ========================================
      // Lessons System
      // ========================================

      let lessonsData = null;
      // currentMode and currentLessonIndex already declared at top of IIFE
      let currentModuleIndex = -1;
      let currentExerciseIndex = 0;

      // DOM Elements for lessons
      const tabLibre = document.getElementById('tab-libre');
      const tabLessons = document.getElementById('tab-lessons');
      const modeLibre = document.getElementById('mode-libre');
      const modeLessons = document.getElementById('mode-lessons');
      const moduleSelect = document.getElementById('lesson-module-select');
      const lessonList = document.getElementById('lesson-list');
      const lessonExercise = document.getElementById('lesson-exercise');
      const lessonWelcome = document.getElementById('lesson-welcome');
      const lessonTitle = document.getElementById('lesson-title');
      const lessonProgress = document.getElementById('lesson-progress');
      const lessonInstruction = document.getElementById('lesson-instruction');
      const lessonTarget = document.getElementById('lesson-target');
      const lessonInput = document.getElementById('lesson-input');
      const btnPrev = document.getElementById('lesson-prev');
      const btnNext = document.getElementById('lesson-next');
      const btnRestart = document.getElementById('lesson-restart');
      const btnHint = document.getElementById('lesson-hint');

      // Load lessons data
      async function loadLessons() {
        try {
          const response = await fetch('tester/lessons.json');
          if (!response.ok) throw new Error('Failed to load lessons');
          lessonsData = await response.json();
          populateModuleSelect();
          console.log(`Lessons loaded: ${lessonsData.modules.length} modules`);
        } catch (error) {
          console.error('Error loading lessons:', error);
        }
      }

      // Tab switching
      function switchToMode(mode) {
        currentMode = mode;

        if (mode === 'libre') {
          tabLibre.style.background = 'var(--color-accent)';
          tabLibre.style.color = 'var(--color-primary-dark)';
          tabLibre.style.border = 'none';
          tabLessons.style.background = 'var(--bg-secondary)';
          tabLessons.style.color = 'var(--text-primary)';
          tabLessons.style.border = '1px solid var(--border-color)';
          modeLibre.style.display = 'block';
          modeLessons.style.display = 'none';
          outputEl.focus();
        } else {
          tabLessons.style.background = 'var(--color-accent)';
          tabLessons.style.color = 'var(--color-primary-dark)';
          tabLessons.style.border = 'none';
          tabLibre.style.background = 'var(--bg-secondary)';
          tabLibre.style.color = 'var(--text-primary)';
          tabLibre.style.border = '1px solid var(--border-color)';
          modeLessons.style.display = 'block';
          modeLibre.style.display = 'none';

          // Load lessons if not loaded
          if (!lessonsData) {
            loadLessons();
          }
        }
      }

      tabLibre.addEventListener('click', () => switchToMode('libre'));
      tabLessons.addEventListener('click', () => switchToMode('lessons'));

      // Populate module select dropdown
      function populateModuleSelect() {
        moduleSelect.innerHTML = '<option value="">Choisir un module...</option>';
        lessonsData.modules.forEach((module, idx) => {
          const option = document.createElement('option');
          option.value = idx;
          option.textContent = `${module.icon} ${module.title}`;
          moduleSelect.appendChild(option);
        });
      }

      // Module selection handler
      moduleSelect.addEventListener('change', (e) => {
        const idx = parseInt(e.target.value);
        if (isNaN(idx)) {
          currentModuleIndex = -1;
          lessonList.innerHTML = '';
          lessonExercise.style.display = 'none';
          lessonWelcome.style.display = 'block';
          return;
        }
        currentModuleIndex = idx;
        currentLessonIndex = -1;
        displayLessonList();
      });

      // Display lesson list for selected module
      function displayLessonList() {
        const module = lessonsData.modules[currentModuleIndex];
        lessonList.innerHTML = '';

        module.lessons.forEach((lesson, idx) => {
          const btn = document.createElement('button');
          btn.textContent = lesson.title;
          btn.style.cssText = 'padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-card); color: var(--text-primary); font-size: 12px; cursor: pointer; transition: all 0.2s;';
          btn.addEventListener('click', () => startLesson(idx));
          btn.addEventListener('mouseenter', () => {
            // Don't change color for active button (would make text invisible on accent background)
            if (currentLessonIndex !== idx) {
              btn.style.borderColor = 'var(--color-accent)';
              btn.style.color = 'var(--color-accent)';
            }
          });
          btn.addEventListener('mouseleave', () => {
            if (currentLessonIndex !== idx) {
              btn.style.borderColor = 'var(--border-color)';
              btn.style.color = 'var(--text-primary)';
            }
          });
          lessonList.appendChild(btn);
        });

        lessonExercise.style.display = 'none';
        lessonWelcome.style.display = 'block';
      }

      // Start a lesson
      function startLesson(lessonIdx) {
        currentLessonIndex = lessonIdx;
        currentExerciseIndex = 0;

        // Highlight active lesson button
        [...lessonList.children].forEach((btn, idx) => {
          if (idx === lessonIdx) {
            btn.style.background = 'var(--color-accent)';
            btn.style.color = 'var(--color-primary-dark)';
            btn.style.borderColor = 'var(--color-accent)';
          } else {
            btn.style.background = 'var(--bg-card)';
            btn.style.color = 'var(--text-primary)';
            btn.style.borderColor = 'var(--border-color)';
          }
        });

        lessonWelcome.style.display = 'none';
        lessonExercise.style.display = 'block';
        displayExercise();
      }

      // Track current line in multi-line exercises  
      let currentLineIndex = 0;

      // Display current exercise
      function displayExercise() {
        const module = lessonsData.modules[currentModuleIndex];
        const lesson = module.lessons[currentLessonIndex];
        const exercise = lesson.exercises[currentExerciseIndex];

        // Reset line index for multi-line exercises
        currentLineIndex = 0;

        lessonTitle.textContent = `${module.icon} ${lesson.title}`;
        lessonProgress.textContent = `Exercice ${currentExerciseIndex + 1}/${lesson.exercises.length}`;
        lessonInstruction.textContent = exercise.instruction;

        // Format target text with styling - newlines shown as visible break indicators
        lessonTarget.innerHTML = exercise.content.split('').map(char => {
          if (char === '\n') return '<span class="target-char target-newline">‚Üµ</span><br>';
          return `<span class="target-char">${char === ' ' ? '&nbsp;' : char}</span>`;
        }).join('');

        lessonInput.innerHTML = '';
        lessonInput.focus();

        // Update prev/next buttons
        btnPrev.disabled = currentExerciseIndex === 0 && currentLessonIndex === 0;
        btnPrev.style.opacity = btnPrev.disabled ? '0.5' : '1';
      }

      // Handle input in lesson mode
      lessonInput.addEventListener('input', () => {
        const fullContent = lessonsData.modules[currentModuleIndex].lessons[currentLessonIndex].exercises[currentExerciseIndex].content;
        const lines = fullContent.split('\n');
        const currentTargetLine = lines[currentLineIndex] || '';
        const inputText = lessonInput.textContent;

        // Get only the target chars for the current line
        const allTargetChars = [...lessonTarget.querySelectorAll('.target-char')];

        // Calculate offset for current line
        let charOffset = 0;
        for (let i = 0; i < currentLineIndex; i++) {
          charOffset += lines[i].length + 1; // +1 for \n
        }

        // Get chars for current line only
        const currentLineChars = allTargetChars.slice(charOffset, charOffset + currentTargetLine.length);

        // Compare each character of current line
        [...inputText].forEach((char, idx) => {
          if (idx < currentLineChars.length) {
            if (char === currentTargetLine[idx]) {
              currentLineChars[idx].style.color = '#22c55e'; // Green for correct
              currentLineChars[idx].style.textDecoration = 'none';
            } else {
              currentLineChars[idx].style.color = '#ef4444'; // Red for incorrect
              currentLineChars[idx].style.textDecoration = 'underline';
            }
          }
        });

        // Reset styles for untyped characters in current line
        for (let i = inputText.length; i < currentLineChars.length; i++) {
          currentLineChars[i].style.color = 'var(--text-primary)';
          currentLineChars[i].style.textDecoration = 'none';
        }

        // Check if current line is complete
        if (inputText === currentTargetLine) {
          // Show success feedback briefly
          lessonInput.style.borderColor = '#22c55e';

          setTimeout(() => {
            lessonInput.style.borderColor = 'var(--color-accent)';
            lessonInput.textContent = ''; // Clear input

            if (currentLineIndex < lines.length - 1) {
              // Move to next line
              currentLineIndex++;
              // Mark newline char as done
              const newlineIdx = charOffset + currentTargetLine.length;
              if (allTargetChars[newlineIdx]) {
                allTargetChars[newlineIdx].style.color = '#22c55e';
              }
            } else {
              // All lines complete - auto-advance
              currentLineIndex = 0; // Reset for next exercise
              const lesson = lessonsData.modules[currentModuleIndex].lessons[currentLessonIndex];

              if (currentExerciseIndex < lesson.exercises.length - 1) {
                // Move to next exercise in current lesson
                currentExerciseIndex++;
                displayExercise();
              } else {
                // All exercises complete - move to next lesson
                const currentModule = lessonsData.modules[currentModuleIndex];
                if (currentLessonIndex < currentModule.lessons.length - 1) {
                  // Next lesson in same module
                  currentLessonIndex++;
                  currentExerciseIndex = 0;
                  setTimeout(() => {
                    startLesson(currentLessonIndex);
                  }, 500);
                } else {
                  // Lesson complete - show celebration
                  lessonInput.textContent = 'üéâ Le√ßon termin√©e !';
                  lessonInput.style.textAlign = 'center';
                  lessonInput.style.color = '#22c55e';
                }
              }
            }
          }, 300);
        }
      });

      // Block native input in lesson input
      lessonInput.addEventListener('beforeinput', (e) => {
        if (e.inputType === 'insertText' || e.inputType === 'insertCompositionText') {
          e.preventDefault();
        }
      });
      // Handle physical keyboard in lesson mode
      lessonInput.addEventListener('keydown', (e) => {
        // Stop propagation to prevent document keydown handler from also processing this
        e.stopPropagation();

        // Block native shortcuts except backspace
        if (e.code === 'Escape') {
          e.preventDefault();
          return;
        }
        if (e.code === 'Tab') {
          e.preventDefault();
          return;
        }
        // Handle Enter - insert newline for multiline exercises
        if (e.code === 'Enter') {
          e.preventDefault();
          // Insert newline character
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(document.createTextNode('\n'));
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
          } else {
            lessonInput.textContent += '\n';
          }
          lessonInput.dispatchEvent(new Event('input'));
          return;
        }

        // Remap Mac key codes to match Windows/Linux layout
        const keyCode = remapMacKeyCode(e.code);

        // Handle modifiers
        if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
          keyboard?.setShift(true);
          e.preventDefault();
          return;
        }
        if (e.code === 'CapsLock') {
          // Read actual Caps Lock state from browser (works correctly on all platforms)
          const capsLockActive = e.getModifierState('CapsLock');
          keyboard?.setCaps(capsLockActive);
          e.preventDefault();
          return;
        }
        if (e.code === 'AltRight') {
          keyboard?.setAltGr(true);
          e.preventDefault();
          return;
        }

        // Allow Ctrl shortcuts
        if ((e.ctrlKey && !e.altKey) || e.metaKey) {
          return;
        }

        // Handle backspace
        if (e.code === 'Backspace') {
          if (keyboard?.state?.activeDeadKey) {
            keyboard.clearDeadKey();
            e.preventDefault();
          }
          // Otherwise let default backspace work
          return;
        }

        // Arrow keys - let them work normally
        if (e.code.startsWith('Arrow')) {
          return;
        }

        // Process through AZERTY keyboard
        if (keyboard) {
          keyboard.handleKeyClick(keyCode, true);
          e.preventDefault();
        }
      });

      // Handle keyup for lesson input
      lessonInput.addEventListener('keyup', (e) => {
        if (keyboard) {
          // Remap Mac key codes to match Windows/Linux layout
          const keyCode = remapMacKeyCode(e.code);
          keyboard.releaseKey(keyCode);
          if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') {
            keyboard.setShift(false);
          }
          if (e.code === 'AltRight') {
            keyboard.setAltGr(false);
          }
        }
      });

      // Navigation buttons
      btnNext.addEventListener('click', () => {
        const lesson = lessonsData.modules[currentModuleIndex].lessons[currentLessonIndex];
        if (currentExerciseIndex < lesson.exercises.length - 1) {
          currentExerciseIndex++;
          displayExercise();
        } else if (currentLessonIndex < lessonsData.modules[currentModuleIndex].lessons.length - 1) {
          // Next lesson in module
          startLesson(currentLessonIndex + 1);
        } else if (currentModuleIndex < lessonsData.modules.length - 1) {
          // Next module
          moduleSelect.value = currentModuleIndex + 1;
          moduleSelect.dispatchEvent(new Event('change'));
          startLesson(0);
        }
      });

      btnPrev.addEventListener('click', () => {
        if (currentExerciseIndex > 0) {
          currentExerciseIndex--;
          displayExercise();
        } else if (currentLessonIndex > 0) {
          currentLessonIndex--;
          const prevLesson = lessonsData.modules[currentModuleIndex].lessons[currentLessonIndex];
          currentExerciseIndex = prevLesson.exercises.length - 1;
          startLesson(currentLessonIndex);
        }
      });

      btnRestart.addEventListener('click', () => {
        currentExerciseIndex = 0;
        displayExercise();
      });

      // Hint button - highlight keys for current exercise characters
      btnHint.addEventListener('click', () => {
        const lesson = lessonsData.modules[currentModuleIndex].lessons[currentLessonIndex];
        const exercise = lesson.exercises[currentExerciseIndex];

        // Check if exercise has a specific hintMethod (for Method 2 exercises)
        if (exercise.hintMethod) {
          const { deadKey, baseChar } = exercise.hintMethod;

          // Find key code for base char
          const baseCharData = characterIndex?.characters[baseChar];
          if (baseCharData && baseCharData.methods && baseCharData.methods.length > 0) {
            const baseMethod = baseCharData.methods[0];

            // Create method object with correct property names for highlightSearchMethod
            const customMethod = {
              type: 'deadkey',
              deadkey: deadKey,  // lowercase 'deadkey' to match highlightSearchMethod
              key: baseMethod.key,  // the physical key code
              layer: baseMethod.layer || 'Base'  // layer for the base char
            };

            highlightSearchMethod(customMethod);
          }
          return;
        }

        // Standard hint: use character-index.json data
        const currentChars = lesson.characters || [];
        if (currentChars.length === 0 || !characterIndex) return;

        // Find the first character that hasn't been typed yet
        // Use currentLineIndex which tracks the actual line being typed
        const inputText = lessonInput.textContent;
        const targetLines = exercise.content.split('\n');

        // Use the global currentLineIndex variable (set by the input handler)
        const currentTargetLine = targetLines[currentLineIndex] || targetLines[0] || '';

        // Find next char in current line
        const nextCharInLineIdx = inputText.length;

        if (nextCharInLineIdx < currentTargetLine.length) {
          const nextChar = currentTargetLine[nextCharInLineIdx];
          const charData = characterIndex.characters[nextChar];

          if (charData && charData.methods && charData.methods.length > 0) {
            const method = charData.methods.find(m => m.recommended) || charData.methods[0];
            highlightSearchMethod(method);
          }
        }
      });

      // Handle keyboard clicks in lesson mode
      const originalOnKeyClick = null; // Will be set after keyboard init

    })();
  </script>
</body>

</html>